name: Deploy to Azure App Service (Production)

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allows manual deployment from GitHub UI

env:
  AZURE_WEBAPP_NAME: healthmesh
  NODE_VERSION: '22.x'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ï¿½ Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: ï¿½ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci --legacy-peer-deps

    - name: ğŸ”¨ Build application
      env:
        VITE_AZURE_AD_CLIENT_ID: 6116990b-c0d4-42fd-bb31-006498740273
        VITE_AZURE_AD_TENANT_ID: e290fb02-d184-4a8c-ae49-c83b04485909
        VITE_AZURE_AD_REDIRECT_URI: https://healthmesh.azurewebsites.net/login
        NODE_ENV: production
      run: npm run build

    - name: ğŸ“ Install production dependencies
      run: npm ci --production --ignore-scripts --legacy-peer-deps

    - name: ğŸ“¦ Prepare deployment package
      run: |
        # Create deployment directory
        mkdir -p deploy
        
        # Copy built application
        cp -r dist deploy/
        cp -r node_modules deploy/
        cp package.json deploy/
        
        # Copy shared folder if exists
        if [ -d "shared" ]; then
          cp -r shared deploy/
        fi
        
        # Create simple startup script
        cat > deploy/server.js << 'EOF'
        // Simple startup wrapper for Azure
        import('./dist/index.js').catch(err => {
          console.error('Failed to start server:', err);
          process.exit(1);
        });
        EOF
        
        # Update package.json for Azure
        cd deploy
        cat > package.json << 'EOF'
        {
          "name": "healthmesh",
          "version": "1.0.0",
          "type": "module",
          "scripts": {
            "start": "node server.js"
          },
          "engines": {
            "node": "22.x"
          }
        }
        EOF
        
        cd ..
        
        # Create zip for deployment
        cd deploy
        zip -r ../deploy.zip . -q
        cd ..
        
        echo "âœ… Deployment package created: $(du -h deploy.zip | cut -f1)"

    - name: ğŸ” Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: ğŸš€ Deploy to Azure Web App
      run: |
        echo "ğŸš€ Deploying to Azure App Service..."
        az webapp deploy \
          --resource-group HealthMesh \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --src-path deploy.zip \
          --type zip \
          --async false \
          --timeout 600
        
        echo "â³ Waiting for deployment to stabilize..."
        sleep 30
        
        echo "âœ… Restarting app..."
        az webapp restart \
          --resource-group HealthMesh \
          --name ${{ env.AZURE_WEBAPP_NAME }}

    - name: âœ… Deployment complete
      run: |
        echo "ğŸ‰ Deployment successful!"
        echo "ğŸŒ Application URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
        echo "â° Deployed at: $(date)"
        
        # Test if app is responding
        echo "ğŸ” Testing application..."
        sleep 10
        curl -f -s -o /dev/null -w "HTTP Status: %{http_code}\n" https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net || true

