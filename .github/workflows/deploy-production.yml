name: Deploy Docker Container to Azure

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: healthmesh
  REGISTRY_NAME: healthmeshregistry
  IMAGE_NAME: healthmesh
  NODE_VERSION: '22.x'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üîê Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: üê≥ Login to Azure Container Registry
      run: |
        az acr login --name ${{ env.REGISTRY_NAME }}

    - name: üèóÔ∏è Build Docker image
      run: |
        echo "Building Docker image..."
        docker build \
          --build-arg NODE_ENV=production \
          --build-arg VITE_AZURE_AD_CLIENT_ID=6116990b-c0d4-42fd-bb31-006498740273 \
          --build-arg VITE_AZURE_AD_TENANT_ID=e290fb02-d184-4a8c-ae49-c83b04485909 \
          --build-arg VITE_AZURE_AD_REDIRECT_URI=https://healthmesh.azurewebsites.net/login \
          --tag ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} \
          --tag ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest \
          .
        
        echo "‚úÖ Docker image built successfully"
        docker images | grep healthmesh

    - name: üöÄ Push Docker image to ACR
      run: |
        echo "Pushing image to Azure Container Registry..."
        docker push ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
        docker push ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
        echo "‚úÖ Image pushed successfully"

    - name: ‚öôÔ∏è Configure App Service for Containers
      run: |
        echo "Configuring App Service to use container..."
        
        # Set container settings
        az webapp config container set \
          --resource-group HealthMesh \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --docker-custom-image-name ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} \
          --docker-registry-server-url https://${{ env.REGISTRY_NAME }}.azurecr.io
        
        # Enable continuous deployment (webhook)
        az webapp deployment container config \
          --resource-group HealthMesh \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --enable-cd true
        
        echo "‚úÖ App Service configured"

    - name: üîÑ Restart App Service
      run: |
        echo "Restarting App Service..."
        az webapp restart \
          --resource-group HealthMesh \
          --name ${{ env.AZURE_WEBAPP_NAME }}
        echo "‚úÖ App Service restarted"

    - name: ‚è≥ Wait for deployment
      run: |
        echo "Waiting for app to be ready..."
        sleep 30

    - name: ‚úÖ Deployment complete
      run: |
        echo "üéâ Deployment successful!"
        echo "üåê Application URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
        echo "üì¶ Image: ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}"
        echo "‚è∞ Deployed at: $(date)"
        
        echo "üîç Testing application..."
        sleep 10
        curl -I https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net || echo "App is starting (check logs in Azure Portal)"
