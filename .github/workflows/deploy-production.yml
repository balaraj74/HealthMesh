name: Deploy to Azure App Service (Production)

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allows manual deployment from GitHub UI

env:
  AZURE_WEBAPP_NAME: healthmesh
  NODE_VERSION: '22.x'
  # Force refresh: 2026-02-05

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ï¿½ Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: ï¿½ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci --legacy-peer-deps

    - name: ğŸ”¨ Build application
      env:
        VITE_AZURE_AD_CLIENT_ID: 6116990b-c0d4-42fd-bb31-006498740273
        VITE_AZURE_AD_TENANT_ID: e290fb02-d184-4a8c-ae49-c83b04485909
        VITE_AZURE_AD_REDIRECT_URI: https://healthmesh.azurewebsites.net/login
        NODE_ENV: production
      run: npm run build

    - name: ğŸ“ Install production dependencies
      run: npm ci --production --ignore-scripts --legacy-peer-deps

    - name: ğŸ“¦ Create deployment ZIP
      run: |
        echo "ğŸ“¦ Creating deployment ZIP..."
        
        # Create ZIP with only files that exist
        echo "Including: dist/, node_modules/, package.json"
        zip -r deploy.zip dist node_modules package.json -q
        
        # Add shared folder only if it exists
        if [ -d "shared" ]; then
          echo "Including: shared/"
          zip -r deploy.zip shared -q
        fi
        
        echo "âœ… ZIP created: $(du -h deploy.zip | cut -f1)"
        echo "ğŸ“‹ ZIP contents:"
        unzip -l deploy.zip | head -20

    - name: ğŸ” Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: ğŸš€ Upload deployment package
      run: |
        # Get publishing credentials
        echo "Getting deployment credentials..."
        CREDS=$(az webapp deployment list-publishing-credentials \
          --resource-group HealthMesh \
          --name healthmesh \
          --query "{username:publishingUserName,password:publishingPassword}" \
          --output json)
        
        USERNAME=$(echo $CREDS | jq -r .username)
        PASSWORD=$(echo $CREDS | jq -r .password)
        
        echo "Username: $USERNAME"
        
        # Upload using Kudu REST API (most reliable method)
        echo "Uploading deployment package to Kudu..."
        HTTP_CODE=$(curl -X POST \
          -u "$USERNAME:$PASSWORD" \
          --data-binary @deploy.zip \
          https://healthmesh.scm.azurewebsites.net/api/zipdeploy \
          -H "Content-Type: application/octet-stream" \
          --write-out "%{http_code}" \
          --output /tmp/deploy-response.txt \
          --show-error \
          --max-time 600)
        
        echo "HTTP Response Code: $HTTP_CODE"
        
        if [ $HTTP_CODE -eq 200 ] || [ $HTTP_CODE -eq 202 ]; then
          echo "âœ… Upload successful!"
          cat /tmp/deploy-response.txt
        else
          echo "âŒ Upload failed with HTTP $HTTP_CODE"
          cat /tmp/deploy-response.txt
          exit 1
        fi

    - name: â³ Wait for deployment
      run: |
        echo "Waiting for deployment to complete..."
        sleep 20

    - name: ğŸ”„ Restart app
      run: |
        echo "Restarting application..."
        az webapp restart \
          --resource-group HealthMesh \
          --name healthmesh

    - name: âœ… Deployment complete
      run: |
        echo "ğŸ‰ Deployment successful!"
        echo "ğŸŒ Application URL: https://healthmesh.azurewebsites.net"
        echo "â° Deployed at: $(date)"
        
        echo "â³ Waiting for app to be ready..."
        sleep 15
        
        echo "ğŸ” Testing application..."
        curl -I https://healthmesh.azurewebsites.net || echo "App is starting (this is normal)"


